# electoral-districts
Script for generation of the electoral districts 

Скрипт строит схему одномандатных избирательных округов в формате GeoJSON, используя, где это возможно, информацию о границах муниципальных образований и/или городских районов, которые имеются в базе OpenStreetMap. Использовать скрипт имеет смысл, если территория каждого из избирательных округов почти всюду совпадает с границами муниципальных образований и/или городских районов. 

## Необходимые инструменты

* python, make, wget, ogr2ogr

## Подготовка исходных данных

Для работы скрипта необходимо подготовить информацию о территориях одномандатных округов и запрос к базе OpenStreetMap для получения необходимых данных. 

### Файл с запросом overpass-turbo
Границы требуемых муниципальных образований и/или городских районов хранятся в базе OpenStreetMap в виде отношений (relations) и запрашиваются оттуда с помощью сервиса [overpass-turbo](https://overpass-turbo.eu/). Соответствующий запрос должен содержаться в файле `overpass.txt`. Необходимые данные данные можно подготовить и любым другим удобным способом и сохранить в файле `source.osm`. 

### Файл с данными о территориях, которые целиком находятся в пределах избирательного округа
Сведения о муниципальных образованиях и/или гододских районах, которые целиком находятся в пределах избирательного округа указываются в файле `full.csv` в виде таблицы
| district      | osm_id | electoral_district |
|---------------|--------|--------------------|
| район Крюково |        | 1                  |
| район Куркино |        | 2                  |
|     ...       |  ...   | ...                |

Сведения о территориях, целиком входящих в пределы соответствующего избирательного округа, задаются в колонках *district* и/или *osm_id*. Значение *osm_id* можно не указывать, но в этом случае в колонке *district* должно быть указано название территории, как оно указано в базе OpenStreetMap (тег name) и это название должно быть уникальным среди всех территорий, полученных с помощью запроса `overpass.txt`. Если же указано *osm_id* ссответствующего отношения, то значение в колонке *district* может быть любым, так как в этом случае сопоставление идет по *osm_id*. В колонке *electoral_district* указывается номер избирательного округа (или любой другой идентификатор избирательного округа), в который входит целиком соответствующая территория

### Файл с данными о территориях, которые разделены между несколькими избирательными округами
Сведения обо всех муниципальных образованиях и/или гододских районах, которые делятся на несколько частей границами избирательных округов необходимо внести в файл `splits.geojson`, который должен содержать один полигональный слой *splits*. В этом файле должен содержаться полигональный слой с атрибутами *district*, *osm_id*, *inside*, *outside*. Атрибуты полигона вида 
| district     | osm_id | inside | outside |
|--------------|--------|--------|---------|
| район Щукино |        |  3     |  5      |
|     ...      |  ...   | ...    | ...     |

означают, что часть района Щукино, содержащаяся внутри соответствующего полигона относится к округу № 3, а оставшаяся часть относится к округу № 5. Скрипт тестировался только для тех случаев, когда муниципальное образование и/или гододской район делится максимум между двумя округами. Если район муниципальное образование и/или гододской район разделен между большим количеством округов, атрибут *outside* не нужно указывать (должет быть равным NULL).  В этом случае скрипт вроде тоже должен работать, но это не проверялось. Логика обработки скриптом значений, указанных в колонках *district*, *osm_id* такая-же, как и в случае обработки аналогичных значений в файле `full.csv`.

Если есть такая возможность, то лучше стараться так расположить полигоны, чтобы они не пересекались. Если этого добиться невозможно, то на получающихся избирательных округах могут появиться артефакты, которые однако не влияют на правильность результата.

### Файл с дополнительными данными об избирательных округах
Дополнительные сведения об избирательных округах необходимо внести в файл `data.csv`. В нем обязательна должна быть колонка *electoral_district*. Информация из остальных колонок будет добавлена в качестве атрибутов в результирующий файл с избирательными округами.

## Использование скрипта
В каталог с файлами `Makefile` и `check.py` нужно поместить файл `overpass.txt` с текстом запроса к сервису overpass-turbo, файлы с описанием границ округов `full.csv`, `splits.geojson`, а также файл с дополнительной информацией `data.csv`.

Скрипт оформлен в виде Makefile'а. Для получения итогового файла достаточно выполнить команду *make* с каталоге, где расположены файлы. В самом конце будет выполнена проверка, все ли необходимые границы были скачаны с помощью запроса из файла `overpass.txt`. Если часть границ будет отсутствовать, то в конце выведется сообщение об этом.

## Примеры
Примеры исходных данных, для построение схемы одномандатных избирательных округов по выборам депутатов Московской городской Думы содержатся в каталогах MoscowCityDuma2014 и MoscowCityDuma2024. Там же содержится результат работы скрипта (файл `electoral_districts.geojson`) 
